<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Psicólogos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #444;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 900px;
      margin: auto;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      background-color: #0078D4;
      color: white;
      border: none;
      transition: 0.3s;
    }
    button:hover {
      background-color: #005fa3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #0078D4;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .actions button {
      margin-right: 5px;
    }
    .actions button:first-child {
      background: #D9534F;
    }
    .actions button:last-child {
      background: #5CB85C;
    }

    /* ==== MODAL ==== */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .modal-content h2 {
      margin-top: 0;
      text-align: center;
    }
    .modal-content input, .modal-content select {
      width: calc(100% - 20px);
      display: block;
      margin: 10px auto;
    }
    .modal-footer {
      text-align: right;
    }
    .modal-footer button {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Gestão de Psicólogos</h1>
  <div class="container">
    <h3>Cadastro de Psicólogo</h3>
    <button onclick="abrirModal()">➕ Cadastrar Psicólogo</button>

    <h3>Lista de Psicólogos</h3>
    <button onclick="listar()">Atualizar Lista</button>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>CRP</th>
          <th>Valor Sessão</th>
          <th>Forma Atendimento</th>
          <th>Telefone</th>
          <th>Email</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

  <!-- MODAL -->
  <div id="modalCadastro" class="modal">
    <div class="modal-content">
      <h2 id="modalTitulo">Cadastro de Psicólogo</h2>
      <input id="nome" placeholder="Nome completo" required>
      <input id="idade" type="number" placeholder="Idade" required>
      <input id="crp" placeholder="CRP" required>
      <input id="tempo_exp" placeholder="Tempo de experiência (em anos)" required>
      <input id="especialidade" placeholder="Especialidade" required>
      <input id="valor_sessao" type="number" placeholder="Valor da sessão (R$)" required>
      <select id="forma_atendimento">
        <option value="">Selecione a forma de atendimento</option>
        <option value="Presencial">Presencial</option>
        <option value="Online">Online</option>
        <option value="Híbrido">Híbrido</option>
      </select>
      <input id="telefone" placeholder="Telefone" required>
      <input id="email" type="email" placeholder="E-mail" required>
      <input id="senha" type="password" placeholder="Senha" required>
      <select id="status">
        <option value="Ativo">Ativo</option>
        <option value="Inativo">Inativo</option>
      </select>

      <div class="modal-footer">
        <button onclick="fecharModal()">Cancelar</button>
        <button id="btnSalvar" onclick="salvar()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:5000/psicologos';
    let editando = false;
    let idEditando = null;

    function abrirModal() {
      document.getElementById('modalCadastro').style.display = 'flex';
      document.getElementById('modalTitulo').textContent = 'Cadastro de Psicólogo';
      document.getElementById('btnSalvar').textContent = 'Cadastrar';
      limparCampos();
      editando = false;
    }

    function fecharModal() {
      document.getElementById('modalCadastro').style.display = 'none';
    }

    function limparCampos() {
      document.querySelectorAll('#modalCadastro input, #modalCadastro select')
        .forEach(el => el.value = '');
    }

    async function listar() {
      const tbody = document.getElementById('tabela');
      tbody.innerHTML = '<tr><td colspan="8">Carregando...</td></tr>';
      try {
        const res = await fetch(API);
        const dados = await res.json();
        tbody.innerHTML = '';
        dados.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td>${p.nome}</td>
              <td>${p.crp}</td>
              <td>${p.valor_sessao || '-'}</td>
              <td>${p.forma_atendimento || '-'}</td>
              <td>${p.telefone || '-'}</td>
              <td>${p.email || '-'}</td>
              <td>${p.status}</td>
              <td class="actions">
                <button onclick="deletar(${p.id})">Excluir</button>
                <button onclick="editar(${p.id})">Editar</button>
              </td>
            </tr>`;
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="8">Erro ao carregar dados.</td></tr>';
        console.error(err);
      }
    }

    function coletarDadosForm() {
      return {
        nome: document.getElementById('nome').value.trim(),
        idade: document.getElementById('idade').value.trim(),
        crp: document.getElementById('crp').value.trim(),
        tempo_exp: document.getElementById('tempo_exp').value.trim(),
        especialidade: document.getElementById('especialidade').value.trim(),
        valor_sessao: document.getElementById('valor_sessao').value.trim(),
        forma_atendimento: document.getElementById('forma_atendimento').value,
        telefone: document.getElementById('telefone').value.trim(),
        email: document.getElementById('email').value.trim(),
        senha: document.getElementById('senha').value.trim(),
        status: document.getElementById('status').value
      };
    }

    async function salvar() {
      const psicologo = coletarDadosForm();
      if (!psicologo.nome || !psicologo.crp || !psicologo.email) {
        return alert('Preencha os campos obrigatórios!');
      }

      if (!editando) {
        // CADASTRAR
        try {
          const res = await fetch(API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(psicologo)
          });
          if (!res.ok) throw new Error('Erro ao cadastrar');
          alert('Psicólogo cadastrado com sucesso!');
          fecharModal();
          listar();
        } catch (err) {
          console.error(err);
          alert('Erro ao cadastrar psicólogo.');
        }
      } else {
        // EDITAR
        try {
          const res = await fetch(`${API}/${idEditando}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(psicologo)
          });
          if (!res.ok) throw new Error('Erro ao editar');
          alert('Dados atualizados com sucesso!');
          fecharModal();
          listar();
        } catch (err) {
          console.error(err);
          alert('Erro ao atualizar dados.');
        }
      }
    }

    async function editar(id) {
      try {
        const res = await fetch(API);
        const lista = await res.json();
        const p = lista.find(x => x.id === id);
        if (!p) return alert('Psicólogo não encontrado');

        document.getElementById('modalCadastro').style.display = 'flex';
        document.getElementById('modalTitulo').textContent = 'Editar Psicólogo';
        document.getElementById('btnSalvar').textContent = 'Atualizar';

        Object.keys(p).forEach(chave => {
          if (document.getElementById(chave)) {
            document.getElementById(chave).value = p[chave];
          }
        });

        editando = true;
        idEditando = id;
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar dados para edição.');
      }
    }

    async function deletar(id) {
      if (!confirm('Deseja realmente excluir este psicólogo?')) return;
      try {
        const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Erro ao excluir');
        alert('Psicólogo excluído com sucesso!');
        listar();
      } catch (err) {
        console.error(err);
        alert('Erro ao excluir psicólogo.');
      }
    }

    listar();
  </script>
</body>
</html>
